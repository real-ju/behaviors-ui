import{e,f as o,g as a,B as s,k as t,G as l,H as r,J as u,K as n,_ as i,o as d,c as p,w as m,a as c,b as f,l as h,q as C,s as v,F as x,i as g,r as k,d as O,h as y}from"./index-0f8f99ee.js";import{_ as R}from"./index.c144a0e1.js";import"./index.7dcf5b2c.js";var S=(e=>(e.IMAGE="image",e.VIDEO="video",e))(S||{}),E=(e=>(e.LOCAL="local",e.PROGRESS="progress",e.SUCCESS="success",e.ERROR="error",e))(E||{});const L=i(e({name:"BeUpload",props:{modelValue:{type:Array,default:()=>[]},defaultFileList:{type:Array,default:()=>[]},chooseImageConfig:{type:Object,default:()=>({})},chooseVideoConfig:{type:Object,default:()=>({})},autoUpload:{type:Boolean,default:!0},maxCount:{type:Number,default:1/0},action:{type:String,default:""},header:{type:Object,default:()=>({})},formData:{type:Object,default:()=>({})},hooks:{type:Object,default:()=>({onResponse:e=>e.url})}},emits:["update:modelValue"],setup(e,{expose:i,emit:d}){const p=e,m={count:9,sizeType:["original","compressed"],sourceType:["album","camera"],maxSize:10240},c={sourceType:["album","camera"],compressed:!0,maxDuration:60,camera:"back",maxSize:102400},f=o([]),h=a((()=>f.value.length>=p.maxCount));s((()=>p.defaultFileList),(()=>{C()}));const C=()=>{if(p.defaultFileList.length>p.maxCount)throw p.hooks.onOverCount&&p.hooks.onOverCount(),"default-file-list超出文件数量限制";f.value=p.defaultFileList.map((e=>{let o=b();return{uuid:o,type:e.type||S.IMAGE,name:e.name||o,url:e.url,status:E.SUCCESS,progress:100}})),y()},v=(e={})=>{if(h.value)throw p.hooks.onOverCount&&p.hooks.onOverCount(),"超出文件数量限制";let o={...m,...p.chooseImageConfig,...e};l({...o,success:e=>{let a=e.tempFiles;if(a=Array.isArray(a)?a:[a],a.length+f.value.length>p.maxCount){p.hooks.onOverCount&&p.hooks.onOverCount();const e=new Error("超出文件数量限制");throw e.name="OverCountError",e}let s=o.maxSize;if(a.find((e=>e.size>1024*s)))return void(p.hooks.onOversize&&p.hooks.onOversize({type:"image"}));let t=a.map((e=>{let o=b();return{uuid:o,type:S.IMAGE,name:e.name||o,url:e.path,status:E.LOCAL,progress:0}}));f.value.push(...t),p.hooks.onChooseComplete&&p.hooks.onChooseComplete(e),p.autoUpload&&R()},fail:e=>{if("OverCountError"===e.name)throw e.message;p.hooks.onChooseFail&&p.hooks.onChooseFail(e)}})},x=(e={})=>{if(h.value)throw p.hooks.onOverCount&&p.hooks.onOverCount(),"超出文件数量限制";let o={...c,...p.chooseVideoConfig,...e};r({...o,success:e=>{let a=o.maxSize;if(e.size>1024*a)return void(p.hooks.onOversize&&p.hooks.onOversize({type:"video"}));let s=b(),t={uuid:s,type:S.VIDEO,name:e.name||s,url:e.tempFilePath,status:E.LOCAL,progress:0};f.value.push(t),p.hooks.onChooseComplete&&p.hooks.onChooseComplete(e),p.autoUpload&&R()},fail:e=>{p.hooks.onChooseFail&&p.hooks.onChooseFail(e)}})},g=e=>{e.type===S.IMAGE&&u({urls:[e.url]})},k=e=>{let o=f.value.findIndex((o=>o.uuid===e.uuid));if(-1!==o){let a=e.status;f.value.splice(o,1),a===E.SUCCESS&&y()}},O=()=>{f.value=[],y()},y=()=>{let e=f.value.filter((e=>e.status===E.SUCCESS)).map((e=>e.url));d("update:modelValue",e)},R=async(e=null)=>{let o=[];if(e?e.status===E.LOCAL&&(o=[e]):o=f.value.filter((e=>e.status===E.LOCAL)),0===o.length)throw"暂无可上传的文件";let a=o.map((e=>new Promise(((o,a)=>{e.status=E.PROGRESS;const s="function"==typeof p.formData?p.formData(e)||{}:p.formData;n({url:p.action,fileType:e.type,filePath:e.url,name:"file",header:p.header,formData:s,success:s=>{if(200!==s.statusCode||!s.data)return e.status=E.ERROR,e.progress=0,void a(s);const t=JSON.parse(s.data);let l=p.hooks.onResponse(t);if(l)e.url=l,e.status=E.SUCCESS,e.progress=100,e.response=t,y(),o(s);else{e.status=E.ERROR,e.progress=0;const o=new Error("onResponse 没有返回文件 URL");a(o)}},fail:o=>{e.status=E.ERROR,e.progress=0,a(o)}}).onProgressUpdate((o=>{e.progress=o.progress}))}))));return await Promise.allSettled(a).then((e=>{const a=e.map(((e,a)=>({file:o[a],result:"fulfilled"===e.status?JSON.parse(e.value.data):e.reason})));return p.hooks.onUploaded&&p.hooks.onUploaded(a),a}))},L=async(e=null)=>{if(e){let o=e;if(o.status===E.ERROR)return o.status=E.LOCAL,R(o);throw"只有错误状态的文件才能重新上传"}return f.value.forEach((e=>{e.status===E.ERROR&&(e.status=E.LOCAL)})),R()},b=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const o=16*Math.random()|0;return("x"==e?o:3&o|8).toString(16)}));return C(),i({fileList:f,chooseImage:v,chooseVideo:x,previewImage:g,remove:k,clear:O,upload:R,reUpload:L}),(e,o)=>t(e.$slots,"default",{fileList:f.value,chooseImage:v,chooseVideo:x,previewImage:g,remove:k,clear:O,upload:R,reUpload:L},void 0,!0)}}),[["__scopeId","data-v-5a73ad79"]]),b=i(e({__name:"image",setup(e){const a=o([]),s=o(),t={Authorization:"token"},l=e=>e.data.url,r=async()=>{0!==s.value.fileList.length?await s.value.upload():console.log("请添加图片")};return(e,o)=>{const u=g,n=y,i=k(O("be-upload"),L),S=k(O("be-button"),R);return d(),p(u,{class:"playground upload-image-page"},{default:m((()=>[c(i,{modelValue:a.value,"onUpdate:modelValue":o[0]||(o[0]=e=>a.value=e),ref_key:"uploaderRef",ref:s,"auto-upload":!1,"max-count":9,action:"/",header:t,hooks:{onResponse:l}},{default:m((({fileList:e,chooseImage:o,previewImage:a,remove:s})=>[c(u,{class:"file-list"},{default:m((()=>[e.length<9?(d(),p(u,{key:0,class:"add-btn",onClick:o},{default:m((()=>[f("+")])),_:2},1032,["onClick"])):h("v-if",!0),(d(!0),C(x,null,v(e,(e=>(d(),p(u,{class:"file-item",key:e.uuid},{default:m((()=>[c(u,{class:"remove-btn",onClick:o=>s(e)},{default:m((()=>[f("×")])),_:2},1032,["onClick"]),c(n,{src:e.url,mode:"scaleToFill",onClick:o=>a(e)},null,8,["src","onClick"])])),_:2},1024)))),128))])),_:2},1024)])),_:1},8,["modelValue","hooks"]),c(S,{class:"upload-btn",hover:"",onClick:r},{default:m((()=>[f("上传")])),_:1})])),_:1})}}}),[["__scopeId","data-v-dec05bb0"]]);export{b as default};
